<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sensitive Information</title>
  <!-- Add favicon -->
  <link rel="icon" type="image/svg+xml" href="../img/secure-info.svg">
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="../css/sensitiveInfo.css">
  <link rel="stylesheet" href="../css/monthlyExport.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    window.supabase = window.supabase || {};
    window.supabase = window.supabase.createClient(
      "https://znuxahdqxencqtsvxvja.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpudXhhaGRxeGVuY3F0c3Z4dmphIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc4MDQzNjUsImV4cCI6MjA1MzM4MDM2NX0.8evCXHMfkn1yhsVB8lQ62BL3b6-j4KZ_oszTuYLT6G0"
    );

    // Password verification
    const SENSITIVE_PASSWORD = "TMHT"; // Must match the one in sensitiveInfo.js
    let isAuthenticated = false;
  </script>
  <style>
    .search-container {
      max-width: 600px;
      /* Increased from 420px to 600px */
      margin: 0 auto 1.5rem;
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 0.75rem 1rem;
      border-radius: 10px;
      border: 2px solid rgba(69, 160, 73, 0.3);
      background: rgba(255, 255, 255, 0.9);
      color: #357d39;
      font-size: 1rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    }

    .search-icon {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #357d39;
      opacity: 0.7;
    }

    #sensitive-content {
      display: none;
      /* Hidden by default until password is verified */
    }

    #password-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #45a049, #245326);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .password-container {
      background: white;
      border-radius: 14px;
      padding: 2rem;
      width: 90%;
      max-width: 450px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      text-align: center;
    }

    .password-header {
      margin-bottom: 1.5rem;
    }

    .password-header svg {
      width: 48px;
      height: 48px;
      margin-bottom: 1rem;
      color: #357d39;
    }

    .password-form {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
  </style>
</head>

<body>
  <!-- Password verification screen -->
  <div id="password-screen">
    <div class="password-container">
      <div class="password-header">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #357d39;">
          <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
          <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
          <circle cx="12" cy="16" r="1"></circle>
        </svg>
        <h2>Sensitive Information</h2>
        <p>Please enter the password to continue</p>
      </div>
      <form id="password-form" class="password-form">
        <div style="position: relative;">
          <input type="password" id="sensitive-password" placeholder="Enter password" required
            style="width: 100%; padding: 0.75rem 1rem; border-radius: 8px; border: 2px solid rgba(69, 160, 73, 0.5); background: white; color: #333;">
          <button type="button" id="toggle-password" tabindex="-1"
            style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer;">
            <span id="eye-icon" style="font-size: 1.2rem;">üëÅÔ∏è</span>
          </button>
        </div>
        <div id="password-error" style="color: #ef4444; font-size: 0.9rem; display: none;">
          Incorrect password. Please try again.
        </div>
        <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
          <button type="submit"
            style="flex: 1; padding: 0.75rem; background: #357d39; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
            Unlock
          </button>
          <a href="../index.html"
            style="flex: 1; padding: 0.75rem; background: #e5e7eb; color: #333; border: none; border-radius: 8px; font-weight: 600; text-decoration: none; text-align: center;">
            Cancel
          </a>
        </div>
      </form>
    </div>
  </div>

  <!-- Main content (hidden until authenticated) -->
  <div id="sensitive-content" class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-7xl">
    <a href="../index.html" class="back-btn">‚Üê Back</a>
    <h1 class="text-3xl font-bold sensitive-title">Sensitive Information</h1>

    <!-- Create Monthly Table Button -->
    <div style="text-align:right;margin-bottom:1.5rem;">
      <button id="openMonthlyExportBtn" class="sensitive-modal-btn"
        style="background:#357d39;color:#fff;padding:0.7em 2em;border:none;border-radius:8px;font-size:1.08rem;font-weight:600;cursor:pointer;">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;margin-right:0.5em;">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
          <path d="M16 3v4a1 1 0 0 0 1 1h4" />
        </svg>
        Create Monthly Table
      </button>
    </div>

    <!-- Search Bar -->
    <div class="search-container">

    </div>
    <input type="text" id="name-search" class="search-input" placeholder="Search by name...">
    <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2">
      <circle cx="11" cy="11" r="8"></circle>
      <path d="M21 21l-4.35-4.35"></path>
    </svg>
  </div>

  <div class="stats-container">
    <div class="stats-outer-container">
      <div class="stats-grid">
        <!-- Overall Total -->
        <div class="stat-card">
          <div class="stat-header" onclick="toggleStatContent(this)">
            <h3>Overall Total</h3>
            <span class="toggle-arrow">‚ñº</span>
          </div>
          <div class="stat-content"
            style="max-height:0;overflow:hidden;transition:max-height 0.4s cubic-bezier(0.4,0,0.2,1);">
            <div class="stat-details">
              <p>Total People: <span id="totalPeople">0</span></p>
              <p>Boys: <span id="totalBoys">0</span></p>
              <p>Girls: <span id="totalGirls">0</span></p>
            </div>
            <div class="stat-details" id="levelStats">
              <!-- Levels will be dynamically added here -->
            </div>
            <!-- Integrated Download Button -->
            <div
              style="text-align:center;margin-top:1.5rem;padding:0.75rem;background:rgba(69,160,73,0.1);border-radius:8px;">
              <button id="downloadButton" class="download-button"
                style="width:100%;max-width:600px;padding:0.9rem;font-size:1.1rem;display:flex;align-items:center;justify-content:center;gap:0.6rem;margin:0 auto;"
                onclick="downloadCSVFiltered()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                  stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="7 10 12 15 17 10"></polyline>
                  <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                Download CSV (Current Results)
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="category-filter">
    <div class="filter-container gradient-box">
      <select id="categoryFilter" class="category-select" onchange="filterByCategory(this.value)">
        <option value="all">All Entries</option>
        <option value="SHS">SHS Students</option>
        <option value="JHS">JHS Students</option>
        <option value="COMPLETED">Completed</option>
        <option value="UNIVERSITY">University</option>
        <option value="duplicates">Show Duplicates</option>
      </select>
    </div>
  </div>
  <!-- Attendance Date Selection Panel -->
  <div class="attendance-date-panel" style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
    <h3 style="color: #fff; margin-bottom: 0.5rem; text-align: center;">Select Active Attendance Date</h3>
    <div style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap;">
      <label style="display: flex; align-items: center; gap: 0.5rem; color: #fff; cursor: pointer;">
        <input type="checkbox" id="global-date-4th" class="global-date-checkbox" data-date="4th"
               style="transform: scale(1.2);" onchange="handleDateSelection('4th', this)">
        <span>4th</span>
      </label>
      <label style="display: flex; align-items: center; gap: 0.5rem; color: #fff; cursor: pointer;">
        <input type="checkbox" id="global-date-11th" class="global-date-checkbox" data-date="11th"
               style="transform: scale(1.2);" onchange="handleDateSelection('11th', this)">
        <span>11th</span>
      </label>
      <label style="display: flex; align-items: center; gap: 0.5rem; color: #fff; cursor: pointer;">
        <input type="checkbox" id="global-date-18th" class="global-date-checkbox" data-date="18th"
               style="transform: scale(1.2);" onchange="handleDateSelection('18th', this)">
        <span>18th</span>
      </label>
      <label style="display: flex; align-items: center; gap: 0.5rem; color: #fff; cursor: pointer;">
        <input type="checkbox" id="global-date-25th" class="global-date-checkbox" data-date="25th"
               style="transform: scale(1.2);" onchange="handleDateSelection('25th', this)">
        <span>25th</span>
      </label>
    </div>
    <div style="text-align: center; margin-top: 1rem;">
      <button id="saveAttendanceDateBtn"
              style="background: #22c55e; color: #fff; border: none; border-radius: 8px; padding: 0.6rem 1.5rem; font-size: 1rem; font-weight: 600; cursor: pointer; transition: background 0.3s ease; display: none;"
              onclick="saveActiveAttendanceDate()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle; margin-right: 0.5rem;">
          <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
          <polyline points="17,21 17,13 7,13 7,21"></polyline>
          <polyline points="7,3 7,8 15,8"></polyline>
        </svg>
        Save Selection
      </button>
    </div>
    <div id="active-date-display" style="text-align: center; margin-top: 0.5rem; color: #fff; font-weight: bold;">
      No attendance date selected
    </div>
  </div>

  <!-- Data Table Section -->
  <div class="sensitive-table-container">
    <table class="sensitive-table" id="sensitiveTable">
      <thead>
        <tr>
          <th style="width: 40px;"><input type="checkbox" id="selectAllCheckbox"
              style="transform: scale(1.2); cursor: pointer;" title="Select/Deselect All"></th>
          <th>Full Name</th>
          <th>Gender</th>
          <th>Phone Number</th>
          <th>Age</th>
          <th>Level</th>
          <th>Attendance 4th</th>
          <th>Attendance 11th</th>
          <th>Attendance 18th</th>
          <th>Attendance 25th</th>
        </tr>
      </thead>
      <tbody id="sensitiveTableBody">
        <tr>
          <td colspan="11" style="text-align:center;color:#888;">Loading data...</td>
        </tr>
      </tbody>
    </table>
  </div>
  <div class="fixed-buttons"></div>

  <!-- Add toast notifications -->
  <div id="successToast" class="toast success"
    style="position:fixed;bottom:20px;left:50%;transform:translateX(-50%);padding:12px 20px;border-radius:8px;background:#22c55e;color:white;display:flex;align-items:center;gap:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:9999;opacity:0;transition:opacity 0.3s ease;max-width:400px;">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path>
    </svg>
    <span>Updated successfully</span>
  </div>
  <div id="errorToast" class="toast error"
    style="position:fixed;bottom:20px;left:50%;transform:translateX(-50%);padding:12px 20px;border-radius:8px;background:#ef4444;color:white;display:flex;align-items:center;gap:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:9999;opacity:0;transition:opacity 0.3s ease;max-width:400px;">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
    </svg>
    <span>Failed to update</span>
  </div>
  </div>

  <!-- Monthly Export Modal -->
  <div id="monthlyExportModal">
    <div class="modal-content">
      <h2>Create Monthly Table</h2>
      <label for="monthSelect">Select Month:</label>
      <select id="monthSelect">
        <option value="" disabled selected>Select Month</option>
        <option value="January">January</option>
        <option value="February">February</option>
        <option value="March">March</option>
        <option value="April">April</option>
        <option value="May">May</option>
        <option value="June">June</option>
        <option value="July">July</option>
        <option value="August">August</option>
        <option value="September">September</option>
        <option value="October">October</option>
        <option value="November">November</option>
        <option value="December">December</option>
      </select>

      <label for="yearInput">Enter Year:</label>
      <input id="yearInput" type="number" min="1900" max="9999" maxlength="4" pattern="\\d{4}" placeholder="e.g. 2025"
        style="width:100%;padding:0.75rem;border-radius:8px;border:1px solid #ddd;font-size:1rem;"
        oninput="if(this.value.length>4)this.value=this.value.slice(0,4);">

      <div id="monthlyExportError"></div>

      <button id="createMonthlyTableBtn">Create Table</button>
    </div>
  </div>

  <script src="../js/app.js"></script>
  <script src="../js/monthlyExport.js"></script>
  <script>
    // Password authentication system
    document.addEventListener('DOMContentLoaded', function () {
      const passwordScreen = document.getElementById('password-screen');
      const sensitiveContent = document.getElementById('sensitive-content');
      const passwordForm = document.getElementById('password-form');
      const passwordInput = document.getElementById('sensitive-password');
      const passwordError = document.getElementById('password-error');
      const togglePasswordBtn = document.getElementById('toggle-password');
      const eyeIcon = document.getElementById('eye-icon');
      const nameSearch = document.getElementById('name-search');

      // Toggle password visibility
      togglePasswordBtn.addEventListener('click', function () {
        if (passwordInput.type === 'password') {
          passwordInput.type = 'text';
          eyeIcon.textContent = 'üôà';
        } else {
          passwordInput.type = 'password';
          eyeIcon.textContent = 'üëÅÔ∏è';
        }
      });

      // Handle password form submission
      passwordForm.addEventListener('submit', function (e) {
        e.preventDefault();

        const password = passwordInput.value.trim();

        if (password === SENSITIVE_PASSWORD) {
          // Password correct - show content
          passwordScreen.style.display = 'none';
          sensitiveContent.style.display = 'block';
          isAuthenticated = true;

          // Initialize table data
          updateSensitiveTable(document.getElementById('categoryFilter').value);
        } else {
          // Password incorrect - show error
          passwordError.style.display = 'block';
          passwordInput.value = '';
          passwordInput.focus();
        }
      });

      // Name search functionality
      nameSearch.addEventListener('input', function () {
        const searchTerm = this.value.trim().toLowerCase();
        if (!window.currentTableData) return;

        if (searchTerm === '') {
          updateSensitiveTable(document.getElementById('categoryFilter').value);
          return;
        }

        const filteredData = window.currentTableData.filter(item =>
          (item["Full Name"] || '').toLowerCase().includes(searchTerm)
        );

        renderTable(filteredData);
        updateStats(filteredData);
      });

      // Open Monthly Export Modal
      const openMonthlyExportBtn = document.getElementById('openMonthlyExportBtn');
      const monthlyExportModal = document.getElementById('monthlyExportModal');
      if (openMonthlyExportBtn && monthlyExportModal) {
        openMonthlyExportBtn.onclick = function () {
          monthlyExportModal.classList.add('show');
        };
        // Optional: close modal when clicking outside modal-content
        monthlyExportModal.onclick = function (e) {
          if (e.target === monthlyExportModal) {
            monthlyExportModal.classList.remove('show');
          }
        };
      }
    });

    // Global attendance date management for sensitive page
    let globalActiveAttendanceDate = null;
    let pendingSelectedDate = null;

    // Function to handle date selection (before saving)
    window.handleDateSelection = function(dateKey, checkbox) {
      // First, uncheck all other checkboxes
      const allCheckboxes = document.querySelectorAll('.global-date-checkbox');
      allCheckboxes.forEach(cb => {
        if (cb !== checkbox) {
          cb.checked = false;
        }
      });

      const saveBtn = document.getElementById('saveAttendanceDateBtn');
      
      if (checkbox.checked) {
        pendingSelectedDate = dateKey;
        saveBtn.style.display = 'inline-block';
        document.getElementById('active-date-display').textContent = `${dateKey} selected (click Save to confirm)`;
        document.getElementById('active-date-display').style.color = '#fbbf24'; // Yellow for pending
      } else {
        pendingSelectedDate = null;
        saveBtn.style.display = 'none';
        // Show current saved state
        if (globalActiveAttendanceDate) {
          document.getElementById('active-date-display').textContent = `${globalActiveAttendanceDate} attendance is active (saved)`;
          document.getElementById('active-date-display').style.color = '#22c55e';
        } else {
          document.getElementById('active-date-display').textContent = 'No attendance date selected';
          document.getElementById('active-date-display').style.color = '#fff';
        }
      }
    };

    // Function to save the selected attendance date
    window.saveActiveAttendanceDate = async function() {
      if (!pendingSelectedDate) {
        showToast("error", "No date selected to save");
        return;
      }

      try {
        // Disable save button while processing
        const saveBtn = document.getElementById('saveAttendanceDateBtn');
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';

        // Save to database for global access across all devices
        const { data, error } = await window.supabase
          .from('May_2025')
          .upsert({
            id: 'global_attendance_date',
            'Full Name': 'SYSTEM_SETTING_ACTIVE_ATTENDANCE_DATE',
            'Gender': pendingSelectedDate,
            'Phone Number': new Date().toISOString(),
            'Age': 'SYSTEM',
            'Current Level': 'ACTIVE_DATE'
          }, {
            onConflict: 'id'
          });

        if (error) throw error;

        // Also save locally as backup
        globalActiveAttendanceDate = pendingSelectedDate;
        localStorage.setItem('globalActiveAttendanceDate', globalActiveAttendanceDate);
        
        // Update display
        document.getElementById('active-date-display').textContent = `${globalActiveAttendanceDate} attendance is active (saved globally)`;
        document.getElementById('active-date-display').style.color = '#22c55e';
        
        // Hide save button
        saveBtn.style.display = 'none';
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Selection';
        
        // Update main app's active date if it exists
        if (window.activeAttendanceDate !== undefined) {
          window.activeAttendanceDate = globalActiveAttendanceDate;
        }
        
        // Clear pending selection
        pendingSelectedDate = null;
        
        showToast("success", `${globalActiveAttendanceDate} attendance date saved globally for all devices!`);

      } catch (error) {
        console.error('Error saving attendance date:', error);
        showToast("error", "Failed to save attendance date globally");
        
        // Re-enable button
        const saveBtn = document.getElementById('saveAttendanceDateBtn');
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Selection';
      }
    };

    // Load active date from database on page load
    document.addEventListener('DOMContentLoaded', async function() {
      // Wait a bit for all elements to be ready
      setTimeout(async () => {
        await loadGlobalAttendanceDate();
      }, 100);
    });

    // Function to load global attendance date from database
    async function loadGlobalAttendanceDate() {
      try {
        console.log('Loading global attendance date...');
        
        // Try to fetch from database first
        const { data, error } = await window.supabase
          .from('May_2025')
          .select('Gender')
          .eq('id', 'global_attendance_date')
          .eq('Full Name', 'SYSTEM_SETTING_ACTIVE_ATTENDANCE_DATE')
          .single();

        let savedActiveDate = null;
        
        if (!error && data && data.Gender) {
          // Found in database
          savedActiveDate = data.Gender;
          console.log('Found saved date in database:', savedActiveDate);
          // Also save to localStorage as backup
          localStorage.setItem('globalActiveAttendanceDate', savedActiveDate);
        } else {
          // Fallback to localStorage if database doesn't have it
          savedActiveDate = localStorage.getItem('globalActiveAttendanceDate');
          console.log('Using localStorage fallback:', savedActiveDate);
        }

        if (savedActiveDate) {
          // Set the global variable
          globalActiveAttendanceDate = savedActiveDate;
          
          // Find and check the correct checkbox
          const checkbox = document.getElementById(`global-date-${savedActiveDate}`);
          console.log('Looking for checkbox:', `global-date-${savedActiveDate}`, 'Found:', checkbox);
          
          if (checkbox) {
            // Uncheck all other checkboxes first
            const allCheckboxes = document.querySelectorAll('.global-date-checkbox');
            allCheckboxes.forEach(cb => cb.checked = false);
            
            // Check the correct one
            checkbox.checked = true;
            
            // Update display
            const displayElement = document.getElementById('active-date-display');
            if (displayElement) {
              displayElement.textContent = `${savedActiveDate} attendance is active (saved globally)`;
              displayElement.style.color = '#22c55e';
            }
            
            console.log('Successfully applied saved state for:', savedActiveDate);
          } else {
            console.error('Checkbox not found for date:', savedActiveDate);
          }
          
          // Set main app's active date if it exists
          if (window.activeAttendanceDate !== undefined) {
            window.activeAttendanceDate = globalActiveAttendanceDate;
          }
          
          // Hide save button since we're loading a saved state
          const saveBtn = document.getElementById('saveAttendanceDateBtn');
          if (saveBtn) {
            saveBtn.style.display = 'none';
          }
          
          // Clear any pending selection
          pendingSelectedDate = null;
        } else {
          console.log('No saved attendance date found');
        }
      } catch (error) {
        console.error('Error loading global attendance date:', error);
        // Fallback to localStorage
        const savedActiveDate = localStorage.getItem('globalActiveAttendanceDate');
        if (savedActiveDate) {
          globalActiveAttendanceDate = savedActiveDate;
          const checkbox = document.getElementById(`global-date-${savedActiveDate}`);
          if (checkbox) {
            // Uncheck all first
            const allCheckboxes = document.querySelectorAll('.global-date-checkbox');
            allCheckboxes.forEach(cb => cb.checked = false);
            
            checkbox.checked = true;
            document.getElementById('active-date-display').textContent = `${savedActiveDate} attendance is active (local backup)`;
            document.getElementById('active-date-display').style.color = '#22c55e';
          }
          document.getElementById('saveAttendanceDateBtn').style.display = 'none';
          pendingSelectedDate = null;
        }
      }
    }

    // --- Filtered Table Logic ---
    async function updateSensitiveTable(category) {
      const tableBody = document.getElementById('sensitiveTableBody');
      tableBody.innerHTML = '<tr><td colspan="11" style="text-align:center;color:#888;">Loading data...</td></tr>';
      try {
        let query = window.supabase.from('May_2025').select('*').order('Full Name');
        if (category && category !== 'all') {
          if (category === 'SHS') {
            query = query.or('Current Level.eq.SHS1,Current Level.eq.SHS2,Current Level.eq.SHS3');
          } else if (category === 'JHS') {
            query = query.or('Current Level.eq.JHS1,Current Level.eq.JHS2,Current Level.eq.JHS3');
          } else {
            query = query.eq('Current Level', category);
          }
        }
        const { data, error } = await query;
        if (error) throw error;
        if (!data || data.length === 0) {
          tableBody.innerHTML = '<tr><td colspan="11" style="text-align:center;color:#888;">No records found.</td></tr>';
          updateStats([]);
          window.currentTableData = [];
          return;
        }

        // Debug info in console
        console.log(`Loaded ${data.length} records successfully`);

        window.currentTableData = data;
        renderTable(data);
        updateStats(data);
      } catch (err) {
        console.error('Database Error:', err);
        // Detailed error message for diagnosis
        tableBody.innerHTML = `
          <tr>
            <td colspan="11" style="padding:15px;text-align:center;color:#e53e3e;">
              <div style="margin-bottom:8px;font-weight:bold">‚ùå Error loading data</div>
              <div style="font-size:0.9rem;padding:8px;background:#fff1f1;border-radius:4px;white-space:pre-wrap;text-align:left;max-width:100%;overflow:auto;">
                ${err.message || 'Unknown error occurred'}
              </div>
              <div style="margin-top:10px;">
                <button onclick="retryDataLoad()" style="padding:6px 12px;background:#3182ce;color:white;border:none;border-radius:4px;cursor:pointer;">
                  üîÑ Retry
                </button>
              </div>
            </td>
          </tr>
        `;
        updateStats([]);
        window.currentTableData = [];
      }
    }

    // Retry function for when data fails to load
    function retryDataLoad() {
      const category = document.getElementById('categoryFilter').value;
      updateSensitiveTable(category);
    }    // Function to render table with provided data
    function renderTable(data) {
      const tableBody = document.getElementById('sensitiveTableBody');
      const selectAllCheckbox = document.getElementById('selectAllCheckbox');

      // Reset select all checkbox state
      if (selectAllCheckbox) {
        selectAllCheckbox.checked = false;
      }

      if (!data || data.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="11" style="text-align:center;color:#888;">No records found.</td></tr>';
        return;
      }

      // For duplicate highlighting if we're in duplicates mode
      const isDuplicateMode = document.getElementById('categoryFilter').value === 'duplicates';
      const nameCounts = {};
      const duplicateNames = [];

      if (isDuplicateMode) {
        // Count occurrences of each name
        data.forEach(item => {
          const name = item["Full Name"] || '';
          nameCounts[name] = (nameCounts[name] || 0) + 1;
        });

        // Find names that appear more than once
        for (const name in nameCounts) {
          if (nameCounts[name] > 1) {
            duplicateNames.push(name);
          }
        }

        // Filter data to only include duplicates
        data = data.filter(item => duplicateNames.includes(item["Full Name"] || ''));
      }

      // Add delete multiple button if in duplicate mode
      if (isDuplicateMode && data.length > 0) {
        const deleteBtn = document.createElement('button');
        deleteBtn.id = 'deleteMultipleBtn';
        deleteBtn.className = 'sensitive-modal-btn';
        deleteBtn.innerHTML = `
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" 
            stroke-linecap="round" stroke-linejoin="round" style="vertical-align:middle;margin-right:0.5em;">
            <polyline points="3 6 5 6 21 6"/>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/>
            <line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/>
          </svg>
          Delete Selected
        `;
        deleteBtn.style.cssText = "background:#ef4444;color:#fff;padding:0.7em 2em;border:none;border-radius:8px;font-size:1.08rem;font-weight:600;cursor:pointer;margin-bottom:1rem;";
        deleteBtn.onclick = deleteSelectedRecords;

        const buttonContainer = document.createElement('div');
        buttonContainer.style.textAlign = 'right';
        buttonContainer.appendChild(deleteBtn);

        const tableContainer = document.querySelector('.sensitive-table-container');
        tableContainer.insertBefore(buttonContainer, tableContainer.firstChild);
      }

      if (data.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="11" style="text-align:center;color:#888;">No duplicate records found.</td></tr>';
        return;
      }

      tableBody.innerHTML = data.map(item => {
        const isDuplicate = isDuplicateMode && duplicateNames.includes(item["Full Name"] || '');
        const rowStyle = isDuplicate ? 'background-color: rgba(254, 202, 202, 0.2);' : '';

        return `
        <tr style="${rowStyle}" class="data-row" data-id="${item.id}">
          <td style="text-align:center;">
            <input type="checkbox" class="record-checkbox" data-id="${item.id}" style="transform: scale(1.2); cursor: pointer;" onchange="updateSelectedState()">
          </td>
          <td>${item["Full Name"] || ''}</td>
          <td>${item["Gender"] || ''}</td>
          <td>${item["Phone Number"] || ''}</td>
          <td>${item["Age"] || ''}</td>
          <td>${item["Current Level"] || ''}</td>
          <td>${item["Attendance 4nd"] || ''}</td>
          <td>${item["Attendance 11th"] || ''}</td>
          <td>${item["Attendance 18th"] || ''}</td>
          <td style="display:flex;align-items:center;gap:0.5em;justify-content:space-between;">
            <span>${item["Attendance 25rd"] || ''}</span>
            <button class="delete-btn" title="Delete" onclick="showDeleteConfirm('${item.id}', this)" style="background:#ef4444;color:#fff;border:none;border-radius:6px;padding:0.25em 0.6em;cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
            </button>
          </td>
        </tr>
      `}).join('');

      // Add event listener to select all checkbox
      selectAllCheckbox.addEventListener('change', function () {
        const checkboxes = document.querySelectorAll('.record-checkbox');
        checkboxes.forEach(checkbox => {
          checkbox.checked = this.checked;
        });
        updateSelectedState();
      });
    }

    // Function to update selected state and button visibility
    function updateSelectedState() {
      const checkboxes = document.querySelectorAll('.record-checkbox:checked');
      const deleteBtn = document.getElementById('deleteMultipleBtn');

      if (deleteBtn) {
        if (checkboxes.length > 0) {
          deleteBtn.textContent = `Delete Selected (${checkboxes.length})`;
          deleteBtn.style.display = 'inline-block';
        } else {
          deleteBtn.textContent = 'Delete Selected';
        }
      }
    }

    // Function to delete selected records
    function deleteSelectedRecords() {
      const selectedCheckboxes = document.querySelectorAll('.record-checkbox:checked');

      if (selectedCheckboxes.length === 0) {
        showToast("error", "No records selected");
        return;
      }

      const selectedIds = Array.from(selectedCheckboxes).map(checkbox => checkbox.dataset.id);

      // Show confirmation modal
      showMultiDeleteConfirm(selectedIds);
    }

    // Confirmation modal for multi-delete
    function showMultiDeleteConfirm(ids) {
      // Remove any existing modal
      const old = document.getElementById('multiDeleteConfirmModal');
      if (old) old.remove();

      const modal = document.createElement('div');
      modal.id = 'multiDeleteConfirmModal';
      modal.style.position = 'fixed';
      modal.style.top = 0;
      modal.style.left = 0;
      modal.style.width = '100vw';
      modal.style.height = '100vh';
      modal.style.background = 'rgba(0,0,0,0.25)';
      modal.style.display = 'flex';
      modal.style.alignItems = 'center';
      modal.style.justifyContent = 'center';
      modal.style.zIndex = 9999;
      modal.innerHTML = `
        <div style="background:#fff;border-radius:14px;box-shadow:0 4px 24px rgba(53,125,57,0.13);padding:2.2rem 2.5rem 1.7rem 2.5rem;max-width:95vw;text-align:center;min-width:320px;">
          <div style="font-size:2.2rem;margin-bottom:0.5em;">‚ö†Ô∏è</div>
          <div style="font-size:1.15rem;font-weight:600;color:#222;margin-bottom:1.2em;">Are you sure you want to delete <b>${ids.length}</b> selected entr${ids.length === 1 ? 'y' : 'ies'}?</div>
          <div style="display:flex;gap:1.5em;justify-content:center;">
            <button id="multiDeleteYesBtn" style="background:#ef4444;color:#fff;border:none;border-radius:8px;padding:0.7em 2.2em;font-size:1.05rem;font-weight:600;cursor:pointer;transition:background 0.18s;">Yes</button>
            <button id="multiDeleteNoBtn" style="background:#e5e7eb;color:#222;border:none;border-radius:8px;padding:0.7em 2.2em;font-size:1.05rem;font-weight:600;cursor:pointer;transition:background 0.18s;">No</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      document.getElementById('multiDeleteNoBtn').onclick = () => modal.remove();
      document.getElementById('multiDeleteYesBtn').onclick = async () => {
        modal.remove();
        await performMultiDelete(ids);
      };
    }

    // Perform the actual multi-delete
    async function performMultiDelete(ids) {
      try {
        // Disable the delete button while processing
        const deleteBtn = document.getElementById('deleteMultipleBtn');
        if (deleteBtn) {
          deleteBtn.disabled = true;
          deleteBtn.textContent = 'Deleting...';
        }
        // Delete all selected records in parallel
        const { error } = await window.supabase.from('May_2025').delete().in('id', ids);
        if (error) throw error;

        // Remove deleted rows from the table and from currentTableData
        ids.forEach(id => {
          const row = document.querySelector(`tr[data-id='${id}']`);
          if (row) row.remove();
        });
        if (window.currentTableData) {
          window.currentTableData = window.currentTableData.filter(item => !ids.includes(item.id));
          updateStats(window.currentTableData);
        }
        showToast('success', 'Selected entries deleted successfully!');
      } catch (err) {
        showToast('error', 'Failed to delete selected entries');
      } finally {
        const deleteBtn = document.getElementById('deleteMultipleBtn');
        if (deleteBtn) {
          deleteBtn.disabled = false;
          deleteBtn.textContent = 'Delete Selected';
        }
      }
    }

    // Update stats based on filtered data
    function updateStats(data) {
      document.getElementById('totalPeople').textContent = data.length;
      let boys = 0, girls = 0;
      const levelCounts = {};
      const levelOrder = [
        'SHS1', 'SHS2', 'SHS3', 'JHS1', 'JHS2', 'JHS3', 'COMPLETED', 'UNIVERSITY'
      ];
      for (const level of levelOrder) levelCounts[level] = 0;

      data.forEach(item => {
        // Updated to use proper column names in May_2025 table
        if ((item["Gender"] || '').toLowerCase() === 'male') boys++;
        if ((item["Gender"] || '').toLowerCase() === 'female') girls++;
        const lvl = (item["Current Level"] || '').toUpperCase();
        if (levelCounts.hasOwnProperty(lvl)) levelCounts[lvl]++;
      });

      document.getElementById('totalBoys').textContent = boys;
      document.getElementById('totalGirls').textContent = girls;
      document.getElementById('levelStats').innerHTML = levelOrder.map(lvl =>
        `<div class="level-stat"><span class="level-name">${lvl}</span><span class="level-count">${levelCounts[lvl]}</span></div>`
      ).join('');
    }

    // Download only currently displayed table data
    function downloadCSVFiltered() {
      const data = window.currentTableData || [];
      if (!data.length) {
        alert('No data to export.');
        return;
      }

      // Use the correct column names from May_2025 table
      const headers = [
        'Full Name', 'Gender', 'Phone Number', 'Age', 'Current Level',
        'Attendance 4nd', 'Attendance 11th', 'Attendance 18th', 'Attendance 25rd'
      ];

      let csvContent = headers.join(',') + '\n';
      csvContent += data.map(item => [
        item["Full Name"] || '',
        item["Gender"] || '',
        item["Phone Number"] || '', // swapped
        item["Age"] || '', // swapped
        item["Current Level"] || '',
        item["Attendance 4nd"] || '',
        item["Attendance 11th"] || '',
        item["Attendance 18th"] || '',
        item["Attendance 25rd"] || ''
      ].map(cell => cell.toString().replace(/"/g, '""')).map(cell => cell.includes(',') ? '"' + cell + '"' : cell).join(',')).join('\n');

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `TMHT_Export_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Show toast notification
    function showToast(type, message) {
      const toast = type === "success" ?
        document.getElementById("successToast") :
        document.getElementById("errorToast");

      if (!toast) return;

      // Update toast content with icon
      toast.innerHTML = `
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          ${type === "success"
          ? '<path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"></path>'
          : '<path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>'
        }
        </svg>
        <span>${message}</span>
      `;

      // Show toast with animation
      toast.style.opacity = "1";
      setTimeout(() => {
        toast.style.opacity = "0";
      }, 3000);
    }

    // Improved delete confirmation modal
    function showDeleteConfirm(id, btn) {
      // Remove any existing modal
      const old = document.getElementById('deleteConfirmModal');
      if (old) old.remove();
      // Create modal
      const modal = document.createElement('div');
      modal.id = 'deleteConfirmModal';
      modal.style.position = 'fixed';
      modal.style.top = 0;
      modal.style.left = 0;
      modal.style.width = '100vw';
      modal.style.height = '100vh';
      modal.style.background = 'rgba(0,0,0,0.25)';
      modal.style.display = 'flex';
      modal.style.alignItems = 'center';
      modal.style.justifyContent = 'center';
      modal.style.zIndex = 9999;
      modal.innerHTML = `
        <div style="background:#fff;border-radius:14px;box-shadow:0 4px 24px rgba(53,125,57,0.13);padding:2.2rem 2.5rem 1.7rem 2.5rem;max-width:95vw;text-align:center;min-width:320px;">
          <div style="font-size:2.2rem;margin-bottom:0.5em;">‚ö†Ô∏è</div>
          <div style="font-size:1.15rem;font-weight:600;color:#222;margin-bottom:1.2em;">Are you sure you want to delete this entry?</div>
          <div style="display:flex;gap:1.5em;justify-content:center;">
            <button id="deleteYesBtn" style="background:#ef4444;color:#fff;border:none;border-radius:8px;padding:0.7em 2.2em;font-size:1.05rem;font-weight:600;cursor:pointer;transition:background 0.18s;">Yes</button>
            <button id="deleteNoBtn" style="background:#e5e7eb;color:#222;border:none;border-radius:8px;padding:0.7em 2.2em;font-size:1.05rem;font-weight:600;cursor:pointer;transition:background 0.18s;">No</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      document.getElementById('deleteNoBtn').onclick = () => modal.remove();
      document.getElementById('deleteYesBtn').onclick = () => {
        modal.remove();
        btn.disabled = true;
        btn.style.opacity = '0.6';
        window.supabase
          .from('May_2025')
          .delete()
          .eq('id', id)
          .then(({ error }) => {
            if (error) {
              // Replace alert with toast
              showToast("error", "Failed to delete entry");
              btn.disabled = false;
              btn.style.opacity = '';
            } else {
              // Remove the row from the table
              const row = btn.closest('tr');
              if (row) row.remove();

              // Also remove from currentTableData
              if (window.currentTableData) {
                window.currentTableData = window.currentTableData.filter(item => item.id !== id);
                updateStats(window.currentTableData);
              }

              // Replace alert with toast
              showToast("success", "Entry deleted successfully");
            }
          });
      };
    }    // Hook up filter
    document.getElementById('categoryFilter').addEventListener('change', function () {
      // Clear search when changing category
      document.getElementById('name-search').value = '';

      // Remove multi-delete button if switching away from duplicates view
      if (this.value !== 'duplicates') {
        const deleteBtn = document.getElementById('deleteMultipleBtn');
        if (deleteBtn) {
          deleteBtn.parentNode.removeChild(deleteBtn);
        }
      }

      updateSensitiveTable(this.value);
    });

    // Function to filter by category
    function filterByCategory(category) {
      if (category === 'duplicates') {
        // We'll handle duplicates in the renderTable function
        updateSensitiveTable('all'); // First get all data
      } else {
        updateSensitiveTable(category);
      }
    }

    // Fetch and display sensitive data
    async function fetchSensitiveData() {
      // Show loading indicator
      document.getElementById('sensitiveTableBody').innerHTML = '<tr><td colspan="11" class="loading-row">Loading data...</td></tr>';

      try {
        // Get filter value
        const filterValue = document.getElementById('name-search')?.value?.toLowerCase() || '';

        // Prepare query
        let query = window.supabase.from('May_2025').select('*').order('Full Name');

        // Apply name filter if any
        if (filterValue) {
          query = query.ilike('Full Name', `%${filterValue}%`);
        }

        const { data, error } = await query;

        if (error) throw error;

        if (!data || data.length === 0) {
          document.getElementById('sensitiveTableBody').innerHTML = '<tr><td colspan="11" class="empty-row">No records found</td></tr>';
          updateStats([]);
          return;
        }

        // Store data globally for filtering
        window.currentTableData = data;

        // Render table with the data
        renderTable(data);

        // Update statistics
        updateStats(data);
      } catch (err) {
        console.error('Error fetching data:', err);
        document.getElementById('sensitiveTableBody').innerHTML = '<tr><td colspan="11" class="error-row">Error loading data</td></tr>';
      }
    }
  </script>
</body>

</html>