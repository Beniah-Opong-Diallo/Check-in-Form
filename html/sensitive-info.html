<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sensitive Information</title>
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="../css/sensitiveInfo.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    window.supabase = window.supabase || {};
    window.supabase = window.supabase.createClient(
      "https://znuxahdqxencqtsvxvja.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpudXhhaGRxeGVuY3F0c3Z4dmphIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc4MDQzNjUsImV4cCI6MjA1MzM4MDM2NX0.8evCXHMfkn1yhsVB8lQ62BL3b6-j4KZ_oszTuYLT6G0"
    );
  </script>
</head>

<body>
  <div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-7xl">
    <a href="../index.html" class="back-btn">← Back</a>
    <h1 class="text-3xl font-bold sensitive-title">Sensitive Information</h1>
    <div class="stats-container">
      <div class="stats-outer-container">
        <div class="stats-grid">
          <!-- Overall Total -->
          <div class="stat-card">
            <div class="stat-header" onclick="toggleStatContent(this)">
              <h3>Overall Total</h3>
              <span class="toggle-arrow">▼</span>
            </div>
            <div class="stat-content">
              <div class="stat-details">
                <p>Total People: <span id="totalPeople">0</span></p>
              </div>
            </div>
          </div>
          <!-- Total Boys and Girls -->
          <div class="stat-card">
            <div class="stat-header" onclick="toggleStatContent(this)">
              <h3>Total Boys and Girls</h3>
              <span class="toggle-arrow">▼</span>
            </div>
            <div class="stat-content">
              <div class="stat-details">
                <p>Boys: <span id="totalBoys">0</span></p>
                <p>Girls: <span id="totalGirls">0</span></p>
              </div>
            </div>
          </div>
          <!-- Total People by Level -->
          <div class="stat-card">
            <div class="stat-header" onclick="toggleStatContent(this)">
              <h3>Total by Level</h3>
              <span class="toggle-arrow">▼</span>
            </div>
            <div class="stat-content">
              <div class="stat-details" id="levelStats">
                <!-- Levels will be dynamically added here -->
              </div>
              <div style="text-align:center; margin-top:1rem;">
                <button id="downloadButton" class="download-button" onclick="downloadCSV()">Download CSV</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="category-filter">
      <div class="filter-container gradient-box">
        <select id="categoryFilter" class="category-select" onchange="filterByCategory(this.value)">
          <option value="all">All Entries</option>
          <option value="SHS">SHS Students</option>
          <option value="JHS">JHS Students</option>
          <option value="COMPLETED">Completed</option>
          <option value="UNIVERSITY">University</option>
        </select>
      </div>
    </div>
    <!-- Data Table Section -->
    <div class="sensitive-table-container">
      <table class="sensitive-table" id="sensitiveTable">
        <thead>
          <tr>
            <th>Full Name</th>
            <th>Gender</th>
            <th>Age</th>
            <th>Phone</th>
            <th>Level</th>
            <th>Attendance 2nd</th>
            <th>Attendance 9th</th>
            <th>Attendance 16th</th>
            <th>Attendance 23rd</th>
          </tr>
        </thead>
        <tbody id="sensitiveTableBody">
          <tr>
            <td colspan="9" style="text-align:center;color:#888;">Loading data...</td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="fixed-buttons"></div>
  </div>
  <script src="../js/app.js"></script>
  <script src="../js/sensitiveInfo.js"></script>
  <script>
    // --- Filtered Table Logic ---
    async function updateSensitiveTable(category) {
      const tableBody = document.getElementById('sensitiveTableBody');
      tableBody.innerHTML = '<tr><td colspan="9" style="text-align:center;color:#888;">Loading data...</td></tr>';
      try {
        let query = window.supabase.from('TMHCT_Feb').select('*').order('full_name');
        if (category && category !== 'all') {
          if (category === 'SHS') {
            query = query.or('current_level.eq.SHS1,current_level.eq.SHS2,current_level.eq.SHS3');
          } else if (category === 'JHS') {
            query = query.or('current_level.eq.JHS1,current_level.eq.JHS2,current_level.eq.JHS3');
          } else {
            query = query.eq('current_level', category);
          }
        }
        const { data, error } = await query;
        if (error) throw error;
        if (!data || data.length === 0) {
          tableBody.innerHTML = '<tr><td colspan="9" style="text-align:center;color:#888;">No records found.</td></tr>';
          return;
        }
        tableBody.innerHTML = data.map(item => `
          <tr>
            <td>${item.full_name || ''}</td>
            <td>${item.gender || ''}</td>
            <td>${item.age || ''}</td>
            <td>${item.phone_number || ''}</td>
            <td>${item.current_level || ''}</td>
            <td>${item.attendance_2nd || ''}</td>
            <td>${item.attendance_9th || ''}</td>
            <td>${item.attendance_16th || ''}</td>
            <td style="display:flex;align-items:center;gap:0.5em;justify-content:space-between;">
              <span>${item.attendance_23rd || ''}</span>
              <button class="delete-btn" title="Delete" onclick="showDeleteConfirm('${item.id}', this)" style="background:#ef4444;color:#fff;border:none;border-radius:6px;padding:0.25em 0.6em;cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
              </button>
            </td>
          </tr>
        `).join('');
      } catch (err) {
        tableBody.innerHTML = '<tr><td colspan="9" style="text-align:center;color:#e53e3e;">Error loading data.</td></tr>';
      }
    }

    // Improved delete confirmation modal
    function showDeleteConfirm(id, btn) {
      // Remove any existing modal
      const old = document.getElementById('deleteConfirmModal');
      if (old) old.remove();
      // Create modal
      const modal = document.createElement('div');
      modal.id = 'deleteConfirmModal';
      modal.style.position = 'fixed';
      modal.style.top = 0;
      modal.style.left = 0;
      modal.style.width = '100vw';
      modal.style.height = '100vh';
      modal.style.background = 'rgba(0,0,0,0.25)';
      modal.style.display = 'flex';
      modal.style.alignItems = 'center';
      modal.style.justifyContent = 'center';
      modal.style.zIndex = 9999;
      modal.innerHTML = `
        <div style="background:#fff;border-radius:14px;box-shadow:0 4px 24px rgba(53,125,57,0.13);padding:2.2rem 2.5rem 1.7rem 2.5rem;max-width:95vw;text-align:center;min-width:320px;">
          <div style="font-size:2.2rem;margin-bottom:0.5em;">⚠️</div>
          <div style="font-size:1.15rem;font-weight:600;color:#222;margin-bottom:1.2em;">Are you sure you want to delete this entry?</div>
          <div style="display:flex;gap:1.5em;justify-content:center;">
            <button id="deleteYesBtn" style="background:#ef4444;color:#fff;border:none;border-radius:8px;padding:0.7em 2.2em;font-size:1.05rem;font-weight:600;cursor:pointer;transition:background 0.18s;">Yes</button>
            <button id="deleteNoBtn" style="background:#e5e7eb;color:#222;border:none;border-radius:8px;padding:0.7em 2.2em;font-size:1.05rem;font-weight:600;cursor:pointer;transition:background 0.18s;">No</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      document.getElementById('deleteNoBtn').onclick = () => modal.remove();
      document.getElementById('deleteYesBtn').onclick = () => {
        modal.remove();
        btn.disabled = true;
        btn.style.opacity = '0.6';
        window.supabase
          .from('TMHCT_Feb')
          .delete()
          .eq('id', id)
          .then(({ error }) => {
            if (error) {
              alert('Error deleting entry.');
              btn.disabled = false;
              btn.style.opacity = '';
            } else {
              // Remove the row from the table
              const row = btn.closest('tr');
              if (row) row.remove();
              // Show a notice (toast)
              if (window.showToast) {
                window.showToast('success', 'Entry deleted successfully');
              } else {
                alert('Entry deleted successfully');
              }
            }
          });
      };
    }

    // Hook up filter
    document.getElementById('categoryFilter').addEventListener('change', function () {
      updateSensitiveTable(this.value);
    });
    // Initial load
    document.addEventListener('DOMContentLoaded', function () {
      updateSensitiveTable(document.getElementById('categoryFilter').value);
    });
  </script>
</body>

</html>